<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Admin - Climax Brains Academy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    :root {
        --primary-color: #1a5fb4;  /* Blue */
        --secondary-color: #f6d32d;  /* Yellow */
        --accent-color: #1a5fb4;  /* Blue */
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
    }
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: none;
    }
    .card-header {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
    }
    .badge-primary {
        background-color: var(--primary-color);
    }
    .badge-secondary {
        background-color: var(--secondary-color);
        color: #333; /* Dark text for better contrast on yellow */
    }
    .filter-container {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .high-score {
        color: #28a745;
        font-weight: 600;
    }
    .medium-score {
        color: #ffc107;
        font-weight: 600;
    }
    .low-score {
        color: #dc3545;
        font-weight: 600;
    }
    .nav-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .nav-tabs .nav-link {
        color: var(--primary-color);
    }
</style>
    <!-- Add jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-graduation-cap me-2"></i> Exam Results Dashboard</h1>
                    <button id="exportBtn" class="btn btn-success">
                        <i class="fas fa-file-export me-2"></i>Export to Excel
                    </button>
                </div>
                <p class="text-muted">View and analyze student exam results</p>
            </div>
        </div>

        <div class="filter-container">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Class</label>
                    <select class="form-select" id="filterClass">
                        <option value="">All Classes</option>
                        <option value="jss1">JSS 1</option>
                        <option value="jss2">JSS 2</option>
                        <option value="jss3">JSS 3</option>
                        <option value="sss1">SSS 1</option>
                        <option value="sss2">SSS 2</option>
                        <option value="sss3">SSS 3</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select class="form-select" id="filterSubject">
                        <option value="">All Subjects</option>
                        <option value="mathematics">Mathematics</option>
                        <option value="english">English</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="biology">Biology</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Exam Type</label>
                    <select class="form-select" id="filterExamType">
                        <option value="">All Types</option>
                        <option value="ca">Continuous Assessment</option>
                        <option value="midterm">Midterm Exam</option>
                        <option value="exam">End of Term Exam</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Term</label>
                    <select class="form-select" id="filterTerm">
                        <option value="">All Terms</option>
                        <option value="1st">1st Term</option>
                        <option value="2nd">2nd Term</option>
                        <option value="3rd">3rd Term</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="d-flex justify-content-end gap-2">
                        <button id="applyFilters" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                        <button id="resetFilters" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
     
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cog me-2"></i>Exam Portal Management
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="toggleExamPortal" style="width: 3em; height: 1.5em;">
                            <label class="form-check-label" for="toggleExamPortal">
                                <h5>Exam Portal Status</h5>
                                <p class="text-muted">Toggle to open/close the exam portal for students</p>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Available Exam Types</label>
                            <div class="form-check">
                                <input class="form-check-input exam-type-check" type="checkbox" value="ca" id="examTypeCA">
                                <label class="form-check-label" for="examTypeCA">
                                    Continuous Assessment (CA)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input exam-type-check" type="checkbox" value="midterm" id="examTypeMidterm">
                                <label class="form-check-label" for="examTypeMidterm">
                                    Midterm Exam
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input exam-type-check" type="checkbox" value="exam" id="examTypeFinal">
                                <label class="form-check-label" for="examTypeFinal">
                                    End of Term Exam
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="examStartDate" class="form-label">Start Date</label>
                            <input type="datetime-local" class="form-control" id="examStartDate">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="examEndDate" class="form-label">End Date</label>
                            <input type="datetime-local" class="form-control" id="examEndDate">
                        </div>
                    </div>
                </div>
                <button id="saveExamSettings" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
                                </div>
                                
                                <!-- Add this right after the Exam Portal Management card -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-alt me-2"></i>Term Report Generation
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Class</label>
                            <select class="form-select" id="reportClass">
                                <option value="">Select Class</option>
                                <option value="jss1">JSS 1</option>
                                <option value="jss2">JSS 2</option>
                                <option value="jss3">JSS 3</option>
                                <option value="sss1">SSS 1</option>
                                <option value="sss2">SSS 2</option>
                                <option value="sss3">SSS 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Term</label>
                            <select class="form-select" id="reportTerm">
                                <option value="">Select Term</option>
                                <option value="1st">1st Term</option>
                                <option value="2nd">2nd Term</option>
                                <option value="3rd">3rd Term</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Session</label>
                            <input type="text" class="form-control" id="reportSession" placeholder="e.g. 2023/2024">
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="caWeight" class="form-label">CA Weight (%)</label>
                            <input type="number" class="form-control" id="caWeight" value="10" min="0" max="100">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="midtermWeight" class="form-label">Midterm Weight (%)</label>
                            <input type="number" class="form-control" id="midtermWeight" value="20" min="0" max="100">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="examWeight" class="form-label">Exam Weight (%)</label>
                            <input type="number" class="form-control" id="examWeight" value="70" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button id="previewReport" class="btn btn-primary">
                        <i class="fas fa-eye me-2"></i>Preview Report
                    </button>
                    <button id="generatePdf" class="btn btn-success">
                        <i class="fas fa-file-pdf me-2"></i>Generate PDF
                    </button>
                </div>
                
                <div id="reportPreview" class="mt-4 d-none">
                    <div class="card">
                        <div class="card-header">
                            Report Preview
                        </div>
                        <div class="card-body" id="previewContent">
                            <!-- Preview content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Exam Results</span>
                        <div>
                            <span class="badge bg-secondary me-2">Total: <span id="totalResults">0</span></span>
                            <span class="badge bg-primary">Avg Score: <span id="averageScore">0</span>%</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Exam Type</th>
                                        <th>Term/Session</th>
                                        <th>Score</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">Loading data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be added here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Performance Summary
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="250"></canvas>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        Score Distribution
                    </div>
                    <div class="card-body">
                        <canvas id="scoreChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Performance Trends
                    </div>
                    <div class="card-body">
                        <canvas id="trendsChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- In the result details modal (around line 1000) -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exam Result Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultDetails">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printResult">Print Result</button>
                <button type="button" class="btn btn-success" id="saveTheoryScore">Save Theory Score</button>
            </div>
        </div>
    </div>
</div>

    <!-- Firebase and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCLARJE_z6pdpEoMMt2f9JcSvZAmxOwwMM",
  authDomain: "climaxmodels-cbtportal.firebaseapp.com",
  projectId: "climaxmodels-cbtportal",
  storageBucket: "climaxmodels-cbtportal.firebasestorage.app",
  messagingSenderId: "876108384334",
  appId: "1:876108384334:web:263d99ac82bbb350921b1f",
  measurementId: "G-FLQLQPKMMF"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Global variables
let allResults = [];
let filteredResults = [];
let currentPage = 1;
const resultsPerPage = 15;
let performanceChart, scoreChart, trendsChart;
let examSettings = {
    isExamOpen: false,
    availableExamTypes: [],
    startDate: null,
    endDate: null
};
let currentReportData = null;

// DOM Elements
const resultsTable = document.getElementById('resultsTable');
const totalResults = document.getElementById('totalResults');
const averageScore = document.getElementById('averageScore');
const exportBtn = document.getElementById('exportBtn');
const applyFilters = document.getElementById('applyFilters');
const resetFilters = document.getElementById('resetFilters');
const printResult = document.getElementById('printResult');
const toggleExamPortal = document.getElementById('toggleExamPortal');
const examTypeCheckboxes = document.querySelectorAll('.exam-type-check');
const examStartDate = document.getElementById('examStartDate');
const examEndDate = document.getElementById('examEndDate');
const saveExamSettingsBtn = document.getElementById('saveExamSettings');
const previewReportBtn = document.getElementById('previewReport');
const generatePdfBtn = document.getElementById('generatePdf');

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadResults();
    loadExamSettings();
    
    // Event listeners
    applyFilters.addEventListener('click', applyResultsFilters);
    resetFilters.addEventListener('click', resetResultsFilters);
    exportBtn.addEventListener('click', exportToExcel);
    printResult.addEventListener('click', printResultDetails);
    saveExamSettingsBtn.addEventListener('click', saveExamSettings);
    previewReportBtn.addEventListener('click', previewTermReport);
    generatePdfBtn.addEventListener('click', generateTermReportPdf);
});

// ==================== RESULTS MANAGEMENT ====================

// Load results from Firebase
function loadResults() {
    const resultsRef = database.ref('examResults');
    
    resultsRef.on('value', (snapshot) => {
        allResults = [];
        let totalScore = 0;
        
        snapshot.forEach(childSnapshot => {
            const result = childSnapshot.val();
            result.id = childSnapshot.key;
            
            if (!result.timestamp) {
                result.timestamp = result.submittedAt || new Date().toISOString();
            }
            
            allResults.push(result);
            
            if (result.objectiveScore) {
                totalScore += result.objectiveScore;
            }
        });
        
        allResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        filteredResults = [...allResults];
        updateResultsTable();
        updateCharts();
        
        const avg = allResults.length > 0 ? Math.round(totalScore / allResults.length) : 0;
        averageScore.textContent = avg;
        totalResults.textContent = allResults.length;
    }, (error) => {
        console.error("Database read failed:", error);
        resultsTable.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-danger">
                    Failed to load results. Please check console for details.
                </td>
            </tr>
        `;
    });
}

// Update results table
function updateResultsTable(page = 1) {
    currentPage = page;
    const startIndex = (page - 1) * resultsPerPage;
    const endIndex = startIndex + resultsPerPage;
    const paginatedResults = filteredResults.slice(startIndex, endIndex);
    
    // Clear existing rows
    resultsTable.innerHTML = '';
    
    if (paginatedResults.length === 0) {
        resultsTable.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">No results found matching your criteria</td>
            </tr>
        `;
    } else {
        // Add new rows
        paginatedResults.forEach(result => {
            const row = document.createElement('tr');
            row.className = 'result-row';
            
            // Format date
            const submittedDate = formatDate(result.timestamp);
            
            // Get score class
            const scoreClass = getScoreClass(result.objectiveScore);
            
            row.innerHTML = `
                <td>${result.name || 'N/A'}</td>
                <td>${result.class ? result.class.toUpperCase() : 'N/A'}</td>
                <td>${result.subject ? capitalizeFirstLetter(result.subject) : 'N/A'}</td>
                <td>${getExamTypeDisplay(result.examType)}</td>
                <td>${result.term ? `${result.term} Term` : ''} ${result.session || ''}</td>
                <td class="${scoreClass}">
                    ${result.objectiveScore || result.objectiveScore === 0 ? result.objectiveScore + '%' : 'N/A'}
                </td>
                <td>${submittedDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-details" data-id="${result.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            resultsTable.appendChild(row);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', () => viewResultDetails(btn.dataset.id));
        });
    }
    
    // Update pagination
    updatePagination();
}

// View detailed result
function viewResultDetails(resultId) {
    const result = allResults.find(r => r.id === resultId);
    if (!result) return;
    
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const detailsContainer = document.getElementById('resultDetails');
    
    // Format the details HTML
    detailsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>Student Information</h5>
                <p><strong>Name:</strong> ${result.name || 'N/A'}</p>
                <p><strong>Class:</strong> ${result.class ? result.class.toUpperCase() : 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h5>Exam Information</h5>
                <p><strong>Subject:</strong> ${result.subject ? capitalizeFirstLetter(result.subject) : 'N/A'}</p>
                <p><strong>Exam Type:</strong> ${getExamTypeDisplay(result.examType)}</p>
                <p><strong>Term/Session:</strong> ${result.term ? `${result.term} Term` : ''} ${result.session || ''}</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        Objective Section
                    </div>
                    <div class="card-body">
                        <h3 class="${getScoreClass(result.objectiveScore)}">
                            ${result.objectiveScore || result.objectiveScore === 0 ? result.objectiveScore + '%' : 'N/A'}
                        </h3>
                        <p class="card-text">Automatically graded</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header ${result.theorySubmitted ? 'bg-success text-white' : 'bg-secondary text-white'}">
                        Theory Section
                    </div>
                    <div class="card-body">
                        <p class="card-text">${result.theorySubmitted ? 'Submitted for grading' : 'Not submitted'}</p>
                    </div>
                </div>
            </div>
        </div>
        
        ${result.answers ? `
        <div class="mt-4">
            <h5>Objective Answers</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Selected Answer</th>
                    </tr>
                </thead>
                <tbody>
                    ${result.answers.map((answer, index) => `
                        <tr>
                            <td>Question ${index + 1}</td>
                            <td>${answer !== null ? `Option ${String.fromCharCode(65 + answer)}` : 'Not answered'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ` : ''}
    `;
    
    modal.show();
}

// Apply filters to results
function applyResultsFilters() {
    const classFilter = document.getElementById('filterClass').value;
    const subjectFilter = document.getElementById('filterSubject').value;
    const examTypeFilter = document.getElementById('filterExamType').value;
    const termFilter = document.getElementById('filterTerm').value;
    
    filteredResults = allResults.filter(result => {
        // Check class filter
        if (classFilter && result.class !== classFilter) return false;
        
        // Check subject filter
        if (subjectFilter && result.subject !== subjectFilter) return false;
        
        // Check exam type filter
        if (examTypeFilter && result.examType !== examTypeFilter) return false;
        
        // Check term filter
        if (termFilter && result.term !== termFilter) return false;
        
        return true;
    });
    
    // Reset to first page and update table
    currentPage = 1;
    updateResultsTable();
    updateCharts();
}

// Reset all filters
function resetResultsFilters() {
    document.getElementById('filterClass').value = '';
    document.getElementById('filterSubject').value = '';
    document.getElementById('filterExamType').value = '';
    document.getElementById('filterTerm').value = '';
    
    filteredResults = [...allResults];
    currentPage = 1;
    updateResultsTable();
    updateCharts();
}

// Update pagination controls
function updatePagination() {
    const totalPages = Math.ceil(filteredResults.length / resultsPerPage);
    const pagination = document.getElementById('pagination');
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
    prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) updateResultsTable(currentPage - 1);
    });
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageLi.addEventListener('click', (e) => {
            e.preventDefault();
            updateResultsTable(i);
        });
        pagination.appendChild(pageLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
    nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) updateResultsTable(currentPage + 1);
    });
    pagination.appendChild(nextLi);
}

// ==================== EXAM SETTINGS MANAGEMENT ====================

// Load exam settings from Firebase
function loadExamSettings() {
    const settingsRef = database.ref('examAvailability');
    
    settingsRef.on('value', (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
            examSettings = settings;
            
            toggleExamPortal.checked = examSettings.isExamOpen || false;
            
            examTypeCheckboxes.forEach(checkbox => {
                checkbox.checked = examSettings.availableExamTypes?.includes(checkbox.value) || false;
            });
            
            if (examSettings.startDate) {
                examStartDate.value = formatDateTimeForInput(examSettings.startDate);
            }
            if (examSettings.endDate) {
                examEndDate.value = formatDateTimeForInput(examSettings.endDate);
            }
        }
    });
}

// Save exam settings to Firebase
function saveExamSettings() {
    const settingsRef = database.ref('examAvailability');
    
    const selectedExamTypes = [];
    examTypeCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedExamTypes.push(checkbox.value);
        }
    });
    
    const settings = {
        isExamOpen: toggleExamPortal.checked,
        availableExamTypes: selectedExamTypes,
        startDate: examStartDate.value ? new Date(examStartDate.value).toISOString() : null,
        endDate: examEndDate.value ? new Date(examEndDate.value).toISOString() : null,
        lastUpdated: new Date().toISOString()
    };
    
    settingsRef.set(settings)
        .then(() => {
            showAlert('success', 'Exam settings saved successfully!');
        })
        .catch(error => {
            console.error('Error saving exam settings:', error);
            showAlert('danger', 'Failed to save exam settings.');
        });
}

// ==================== REPORT GENERATION ====================

// Preview term report
function previewTermReport() {
    const classVal = document.getElementById('reportClass').value;
    const termVal = document.getElementById('reportTerm').value;
    const sessionVal = document.getElementById('reportSession').value.trim();
    const caWeight = parseInt(document.getElementById('caWeight').value) || 0;
    const midtermWeight = parseInt(document.getElementById('midtermWeight').value) || 0;
    const examWeight = parseInt(document.getElementById('examWeight').value) || 0;
    
    if (!classVal || !termVal || !sessionVal) {
        showAlert('danger', 'Please select class, term and enter session');
        return;
    }
    
    if (caWeight + midtermWeight + examWeight !== 100) {
        showAlert('danger', 'Total weights must equal 100%');
        return;
    }
    
    // Calculate term totals
    calculateTermTotals(classVal, termVal, sessionVal, caWeight, midtermWeight, examWeight)
        .then(data => {
            currentReportData = data;
            renderReportPreview(data, classVal, termVal, sessionVal);
            document.getElementById('reportPreview').classList.remove('d-none');
        })
        .catch(error => {
            console.error('Error generating report:', error);
            showAlert('danger', 'Failed to generate report. Please check console for details.');
        });
}

// // Calculate term totals for all students
function calculateTermTotals(classVal, termVal, sessionVal, caWeight, midtermWeight, examWeight) {
    return new Promise((resolve, reject) => {
        const resultsRef = database.ref('examResults');
        
        resultsRef.once('value')
            .then(snapshot => {
                const allResults = [];
                snapshot.forEach(childSnapshot => {
                    const result = childSnapshot.val();
                    result.id = childSnapshot.key;
                    allResults.push(result);
                });
                
                // Filter results for the selected class, term and session
                const filtered = allResults.filter(result => 
                    result.class === classVal && 
                    result.term === termVal && 
                    result.session === sessionVal
                );
                
                // Group by student and subject
                const studentData = {};
                
                filtered.forEach(result => {
                    if (!result.name || !result.subject || result.objectiveScore === undefined) return;
                    
                    const studentKey = result.name.toLowerCase().trim();
                    const subjectKey = result.subject.toLowerCase().trim();
                    
                    if (!studentData[studentKey]) {
                        studentData[studentKey] = {
                            name: result.name,
                            subjects: {},
                            class: result.class,
                            term: result.term,
                            session: result.session
                        };
                    }
                    
                    if (!studentData[studentKey].subjects[subjectKey]) {
                        studentData[studentKey].subjects[subjectKey] = {
                            name: result.subject,
                            caScores: [],
                            midtermScores: [],
                            examScores: []
                        };
                    }
                    
                    // Categorize scores by exam type
                    if (result.examType === 'ca') {
                        studentData[studentKey].subjects[subjectKey].caScores.push(result.objectiveScore);
                    } else if (result.examType === 'midterm') {
                        studentData[studentKey].subjects[subjectKey].midtermScores.push(result.objectiveScore);
                    } else if (result.examType === 'exam') {
                        studentData[studentKey].subjects[subjectKey].examScores.push(result.objectiveScore);
                    }
                });
                
                // Calculate averages and totals for each student and subject
                const reportData = Object.values(studentData).map(student => {
                    const subjects = {};
                    
                    Object.entries(student.subjects).forEach(([subjectKey, subjectData]) => {
                        // Calculate CA total (sum of all CA scores scaled to 10)
                        const caSum = subjectData.caScores.length > 0 ? 
                            subjectData.caScores.reduce((a, b) => a + b, 0) : 0;
                        // Scale to 10 (sum of all CA scores / number of CAs * 10)
                        const caTotal = subjectData.caScores.length > 0 ?
                            (caSum / (subjectData.caScores.length * 100)) * 10 : 0;
                        
                        // Calculate Midterm total (sum of all Midterm scores scaled to 20)
                        const midtermSum = subjectData.midtermScores.length > 0 ? 
                            subjectData.midtermScores.reduce((a, b) => a + b, 0) : 0;
                        // Scale to 20 (sum of all Midterm scores / number of Midterms * 20)
                        const midtermTotal = subjectData.midtermScores.length > 0 ?
                            (midtermSum / (subjectData.midtermScores.length * 100)) * 20 : 0;
                        
                        // Calculate Exam total (single exam score scaled to 70)
                        const examTotal = subjectData.examScores.length > 0 ?
                            (subjectData.examScores[0] / 100) * 70 : 0;
                        
                        // Calculate subject total (sum of scaled scores)
                        const subjectTotal = caTotal + midtermTotal + examTotal;
                        
                        subjects[subjectKey] = {
                            name: subjectData.name,
                            caScores: subjectData.caScores,
                            caSum: caSum,
                            caTotal: caTotal,
                            midtermScores: subjectData.midtermScores,
                            midtermSum: midtermSum,
                            midtermTotal: midtermTotal,
                            examScores: subjectData.examScores,
                            examTotal: examTotal,
                            subjectTotal: subjectTotal
                        };
                    });
                    
                    // Calculate overall average
                    const subjectTotals = Object.values(subjects).map(s => s.subjectTotal);
                    const overallAverage = subjectTotals.length > 0 ? 
                        subjectTotals.reduce((a, b) => a + b, 0) / subjectTotals.length : 0;
                    
                    return {
                        ...student,
                        subjects,
                        overallAverage
                    };
                });
                
                // Sort students by name
                reportData.sort((a, b) => a.name.localeCompare(b.name));
                
                resolve({
                    students: reportData,
                    weights: {
                        ca: caWeight,
                        midterm: midtermWeight,
                        exam: examWeight
                    },
                    class: classVal,
                    term: termVal,
                    session: sessionVal
                });
            })
            .catch(error => {
                reject(error);
            });
    });
}

// Render report preview
function renderReportPreview(data, classVal, termVal, sessionVal) {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '';
    
    // Create header
    const header = document.createElement('div');
    header.className = 'text-center mb-4';
    header.innerHTML = `
        <h3>Climax Brains Academy</h3>
        <h4>Term Report Sheet</h4>
        <p>${termVal.toUpperCase()} TERM ${sessionVal} | ${classVal.toUpperCase()}</p>
        <p>CA: ${data.weights.ca}% (over 10) | Midterm: ${data.weights.midterm}% (over 20) | Exam: ${data.weights.exam}% (over 70)</p>
        <hr>
    `;
    previewContent.appendChild(header);
    
    // Create table for each student
    data.students.forEach(student => {
        const studentSection = document.createElement('div');
        studentSection.className = 'mb-4';
        
        const studentHeader = document.createElement('h5');
        studentHeader.textContent = `${student.name}`;
        studentSection.appendChild(studentHeader);
        
        // Create subjects table
        const table = document.createElement('table');
        table.className = 'table table-bordered';
        
        // Table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Subject</th>
                <th>CA Scores</th>
                <th>CA Total</th>
                <th>Midterm Scores</th>
                <th>Midterm Total</th>
                <th>Exam Score</th>
                <th>Subject Total</th>
                <th>Grade</th>
            </tr>
        `;
        table.appendChild(thead);
        
        // Table body
        const tbody = document.createElement('tbody');
        
        Object.values(student.subjects).forEach(subject => {
            const row = document.createElement('tr');
            
            // Helper function to format scores array
            const formatScores = (scores) => {
                return scores.length > 0 ? scores.map(s => Math.round(s)).join(', ') : '-';
            };
            
            // Calculate grade
            const grade = calculateGrade(subject.subjectTotal);
            
            row.innerHTML = `
                <td>${capitalizeFirstLetter(subject.name)}</td>
                <td>${formatScores(subject.caScores)}</td>
                <td>${subject.caScores.length > 0 ? Math.round(subject.caTotal * 10) / 10 : '0'}/10</td>
                <td>${formatScores(subject.midtermScores)}</td>
                <td>${subject.midtermScores.length > 0 ? Math.round(subject.midtermTotal * 10) / 10 : '0'}/20</td>
                <td>${subject.examScores.length > 0 ? Math.round(subject.examScores[0]) + '%' : '-'}</td>
                <td>${Math.round(subject.subjectTotal)}%</td>
                <td>${grade}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Add overall average row
        const footerRow = document.createElement('tr');
        footerRow.className = 'table-active';
        footerRow.innerHTML = `
            <td colspan="6" class="text-end"><strong>Overall Average:</strong></td>
            <td><strong>${Math.round(student.overallAverage)}%</strong></td>
            <td><strong>${calculateGrade(student.overallAverage)}</strong></td>
        `;
        tbody.appendChild(footerRow);
        
        table.appendChild(tbody);
        studentSection.appendChild(table);
        previewContent.appendChild(studentSection);
    });
}

// Generate PDF report
function generateTermReportPdf() {
    if (!currentReportData) {
        showAlert('danger', 'Please preview the report first');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add header
    doc.setFontSize(16);
    doc.setTextColor(106, 13, 173); // Purple color
    doc.text('Climax Brains Academy', 105, 15, { align: 'center' });
    
    doc.setFontSize(14);
    doc.text('Term Report Sheet', 105, 22, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0); // Black color
    doc.text(`${currentReportData.term.toUpperCase()} TERM ${currentReportData.session} | ${currentReportData.class.toUpperCase()}`, 105, 30, { align: 'center' });
    doc.text(`CA: ${currentReportData.weights.ca}% | Midterm: ${currentReportData.weights.midterm}% | Exam: ${currentReportData.weights.exam}%`, 105, 37, { align: 'center' });
    
    // Add student tables
    let yPosition = 45;
    
    currentReportData.students.forEach((student, index) => {
        // Add student name
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${student.name}`, 14, yPosition);
        doc.setFont(undefined, 'normal');
        
        yPosition += 7;
        
        // Prepare data for the table
        const tableData = [];
        
        Object.values(student.subjects).forEach(subject => {
            // Helper function to format scores array
            const formatScores = (scores) => {
                return scores.length > 0 ? scores.map(s => Math.round(s)).join(', ') : '-';
            };
            
            // Calculate grade
            const grade = calculateGrade(subject.subjectTotal);
            
            tableData.push([
                capitalizeFirstLetter(subject.name),
                formatScores(subject.caScores),
                `${Math.round(subject.caAverage)}%`,
                formatScores(subject.midtermScores),
                `${Math.round(subject.midtermAverage)}%`,
                subject.examScores.length > 0 ? `${Math.round(subject.examScores[0])}%` : '-',
                `${Math.round(subject.subjectTotal)}%`,
                grade
            ]);
        });
        
        // Add overall average row
        tableData.push([
            { content: 'Overall Average:', colSpan: 6, styles: { halign: 'right', fontStyle: 'bold' } },
            { content: `${Math.round(student.overallAverage)}%`, styles: { fontStyle: 'bold' } },
            { content: calculateGrade(student.overallAverage), styles: { fontStyle: 'bold' } }
        ]);
        
        // Add table to PDF
        doc.autoTable({
            startY: yPosition,
            head: [['Subject', 'CA Scores', 'CA Avg', 'Midterm Scores', 'Midterm Avg', 'Exam Score', 'Total', 'Grade']],
            body: tableData,
            margin: { left: 10, right: 10 },
            styles: { fontSize: 9 },
            headStyles: { fillColor: [106, 13, 173], textColor: 255, fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [240, 240, 240] }
        });
        
        yPosition = doc.lastAutoTable.finalY + 10;
        
        // Add page break if not the last student and we're running out of space
        if (index < currentReportData.students.length - 1 && yPosition > 250) {
            doc.addPage();
            yPosition = 20;
        }
    });
    
    // Save the PDF
    const fileName = `Term_Report_${currentReportData.class}_${currentReportData.term}_${currentReportData.session}.pdf`;
    doc.save(fileName);
}

// ==================== CHARTS & VISUALIZATION ====================

// Update charts
function updateCharts() {
    updatePerformanceChart();
    updateScoreDistributionChart();
    updateTrendsChart();
}

// Performance chart (by class/subject)
function updatePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Destroy previous chart if exists
    if (performanceChart) {
        performanceChart.destroy();
    }
    
    // Group data by class and subject
    const performanceData = {};
    filteredResults.forEach(result => {
        if (!result.class || !result.subject) return;
        
        if (!performanceData[result.class]) {
            performanceData[result.class] = {};
        }
        
        if (!performanceData[result.class][result.subject]) {
            performanceData[result.class][result.subject] = {
                total: 0,
                count: 0
            };
        }
        
        if (result.objectiveScore) {
            performanceData[result.class][result.subject].total += result.objectiveScore;
            performanceData[result.class][result.subject].count++;
        }
    });
    
    // Prepare chart data
    const classes = Object.keys(performanceData);
    const subjects = Array.from(new Set(filteredResults.map(r => r.subject).filter(Boolean)));
    
    const datasets = subjects.map(subject => {
        return {
            label: capitalizeFirstLetter(subject),
            data: classes.map(cls => {
                const subjData = performanceData[cls][subject];
                return subjData && subjData.count > 0 
                    ? Math.round(subjData.total / subjData.count) 
                    : 0;
            }),
            backgroundColor: getRandomColor()
        };
    });
    
    performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: classes.map(cls => cls.toUpperCase()),
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Average Score (%)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Average Performance by Class and Subject'
                }
            }
        }
    });
}

// Score distribution chart
function updateScoreDistributionChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    
    if (scoreChart) {
        scoreChart.destroy();
    }
    
    // Categorize scores
    const scoreRanges = {
        '90-100': 0,
        '80-89': 0,
        '70-79': 0,
        '60-69': 0,
        '50-59': 0,
        'Below 50': 0
    };
    
    filteredResults.forEach(result => {
        if (result.objectiveScore) {
            if (result.objectiveScore >= 90) scoreRanges['90-100']++;
            else if (result.objectiveScore >= 80) scoreRanges['80-89']++;
            else if (result.objectiveScore >= 70) scoreRanges['70-79']++;
            else if (result.objectiveScore >= 60) scoreRanges['60-69']++;
            else if (result.objectiveScore >= 50) scoreRanges['50-59']++;
            else scoreRanges['Below 50']++;
        }
    });
    
    scoreChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(scoreRanges),
            datasets: [{
                data: Object.values(scoreRanges),
                backgroundColor: [
                    '#28a745',
                    '#5cb85c',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545',
                    '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Score Distribution'
                },
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

// Trends over time chart
function updateTrendsChart() {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    if (trendsChart) {
        trendsChart.destroy();
    }
    
    // Group by date (last 30 days)
    const now = new Date();
    const last30Days = Array.from({ length: 30 }, (_, i) => {
        const date = new Date(now);
        date.setDate(date.getDate() - (29 - i));
        return date.toISOString().split('T')[0];
    });
    
    const dailyAverages = {};
    last30Days.forEach(date => {
        dailyAverages[date] = {
            total: 0,
            count: 0
        };
    });
    
    filteredResults.forEach(result => {
        const resultDate = new Date(result.timestamp).toISOString().split('T')[0];
        if (dailyAverages[resultDate] && result.objectiveScore) {
            dailyAverages[resultDate].total += result.objectiveScore;
            dailyAverages[resultDate].count++;
        }
    });
    
    const labels = last30Days.map(date => formatShortDate(date));
    const data = last30Days.map(date => {
        return dailyAverages[date].count > 0 
            ? Math.round(dailyAverages[date].total / dailyAverages[date].count) 
            : null;
    });
    
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Average Score (%)',
                data: data,
                borderColor: 'rgba(106, 13, 173, 1)',
                backgroundColor: 'rgba(106, 13, 173, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Average Score (%)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Performance Trends (Last 30 Days)'
                }
            }
        }
    });
}

// ==================== UTILITY FUNCTIONS ====================

// Export to Excel
function exportToExcel() {
    if (filteredResults.length === 0) {
        alert('No results to export');
        return;
    }
    
    // Prepare data for export
    const exportData = filteredResults.map(result => {
        return {
            'Student Name': result.name || '',
            'Class': result.class ? result.class.toUpperCase() : '',
            'Subject': result.subject ? capitalizeFirstLetter(result.subject) : '',
            'Exam Type': getExamTypeText(result.examType),
            'Term': result.term || '',
            'Session': result.session || '',
            'Score (%)': result.objectiveScore || '',
            'Theory Submitted': result.theorySubmitted ? 'Yes' : 'No',
            'Date Submitted': formatDate(result.timestamp)
        };
    });
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(exportData);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Exam Results');
    
    // Export to file
    const dateStr = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Exam_Results_${dateStr}.xlsx`);
}

// Print result details
function printResultDetails() {
    const printContent = document.getElementById('resultDetails').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Climax Brains Academy</h2>
                <h3>Exam Result Details</h3>
            </div>
            ${printContent}
            <div style="margin-top: 30px; text-align: right; font-style: italic;">
                Printed on ${new Date().toLocaleDateString()}
            </div>
        </div>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
}

// Show alert message
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.prepend(alertDiv);
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 3000);
}

// Helper function to format datetime for input
function formatDateTimeForInput(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    
    const pad = num => num.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

// Helper function to get exam type display
function getExamTypeDisplay(type) {
    switch(type) {
        case 'ca': return '<span class="badge bg-primary">CA</span>';
        case 'midterm': return '<span class="badge bg-warning text-dark">Midterm</span>';
        case 'exam': return '<span class="badge bg-danger">Exam</span>';
        default: return 'N/A';
    }
}

// Helper function to get exam type text
function getExamTypeText(type) {
    switch(type) {
        case 'ca': return 'Continuous Assessment';
        case 'midterm': return 'Midterm Exam';
        case 'exam': return 'End of Term Exam';
        default: return type || 'N/A';
    }
}

// Helper function to format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';
    
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Helper function to format short date
function formatShortDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
    });
}

// Helper function to capitalize first letter
function capitalizeFirstLetter(string) {
    if (!string) return '';
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Helper function to get score class
function getScoreClass(score) {
    if (score === undefined || score === null) return '';
    if (score >= 70) return 'high-score';
    if (score >= 50) return 'medium-score';
    return 'low-score';
}

// Helper function to get random color
function getRandomColor() {
    return `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
}

// Helper function to calculate grade
function calculateGrade(score) {
    if (score >= 75) return 'A1';
    if (score >= 70) return 'B2';
    if (score >= 65) return 'B3';
    if (score >= 60) return 'C4';
    if (score >= 55) return 'C5';
    if (score >= 50) return 'C6';
    if (score >= 45) return 'D7';
    if (score >= 40) return 'E8';
    return 'F9';
}
    </script>
</body>
</html>
